name:  Aktualizowanie strony przez Tailscale

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      TS_TAG: tag:github-actions
      REMOTE_USER: github-actions
      REMOTE_HOSTNAME: vps
      GITHUB_REPOSITORY: ${{ github.REPOSITORY }}
      GITHUB_REF_NAME: ${{ github.GITHUB_REF_NAME }}
      GITHUB_ACTOR: ${{ github.ACTOR }}
      GITHUB_RUN_NUMBER: ${{ github.RUN_NUMBER }}
      GITHUB_SHA: ${{ github.SHA }}
      DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Tailscale Setup - Połączenie do Tailnet'u
        uses: tailscale/github-action@v3
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_CLIENT_SECRET }}
          tags: ${{ env.TS_TAG }}

      - name: Wyślij powiadomienie na Discord
        run: python3 powiadomienie.py

      - name: Konfiguracja klucza SSH
        run: |
          mkdir -p ~/.ssh/
          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.HOST }} >> ~/.ssh/known_hosts

      - name: Połączenie przez ssh jako github-actions
        run: |
          ssh -i ~/.ssh/id_rsa ${{ env.REMOTE_USER }}@${{ env.REMOTE_HOSTNAME }} 
